# ローカル開発用
# Directus を起動: docker compose up -d directus
# Astro は pnpm dev で別途起動

services:
  directus:
    image: directus/directus:latest
    ports:
      - "8055:8055"
    environment:
      KEY: "replace-with-random-key"
      SECRET: "replace-with-random-secret"
      ADMIN_EMAIL: "admin@example.com"
      ADMIN_PASSWORD: "admin"
      DB_CLIENT: "sqlite3"
      DB_FILENAME: "/directus/database/database.sqlite"
      WEBSOCKETS_ENABLED: "true"
      ASSETS_TRANSFORM_IMAGE_MAX_DIMENSION: 12000
    volumes:
      - directus_data:/directus/database
      - directus_uploads:/directus/uploads

  influxdb:
    image: influxdb:2.7
    ports:
      - "8086:8086"
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: admin
      DOCKER_INFLUXDB_INIT_PASSWORD: akarinext_password
      DOCKER_INFLUXDB_INIT_ORG: akarinext
      DOCKER_INFLUXDB_INIT_BUCKET: server_metrics
    volumes:
      - influxdb_data:/var/lib/influxdb2

    networks:
      - akarinext_network

  monitor:
    image: node:20-alpine
    working_dir: /app
    volumes:
      - ./:/app
    command: sh -c "npm install -g pnpm && pnpm install && pnpm monitor"
    environment:
      - INFLUX_URL=http://influxdb:8086
      - PUBLIC_DIRECTUS_URL=http://directus:8055
      # Add other necessary env vars from .env manually or via env_file
    networks:
      - akarinext_network
    depends_on:
      - directus

volumes:
  directus_data:
  directus_uploads:
  influxdb_data:

networks:
  akarinext_network:
    external: true
    name: akarinext_shared_network
