---
import Layout from "../../layouts/Layout.astro";
import { directus, readItems, skipDirectusFetch } from "../../lib/directus";
import { Megaphone, Calendar, Clock } from "lucide-astro";

let announcements: Array<{
  id: number;
  title: string;
  content: string;
  published_date: string;
}> = [];

if (!skipDirectusFetch) {
  try {
    announcements = (await directus.request(
      readItems("announcements", {
        fields: ["id", "title", "content", "published_date"],
        filter: { status: { _eq: "published" } },
        sort: ["-published_date"],
      })
    )) ?? [];
  } catch (e) {
    // Silent fail
  }
}

const formatDate = (date: string) => {
    return new Date(date).toLocaleDateString('ja-JP', {
       year: 'numeric',
       month: 'short',
       day: 'numeric' 
    });
};
---

<Layout title="Announcements" description="Latest news and updates.">
    <div class="page-header">
        <div class="container text-center">
           <h1 class="page-title"><Megaphone class="icon icon-lg" /> News & Updates</h1>
           <p class="page-desc">
               Stay informed with the latest chances and community events.
           </p>
        </div>
    </div>

    <div class="container container-narrow">
        {announcements.length > 0 ? (
            <div class="timeline-container">
                {announcements.map((ann) => (
                    <article id={`ann-${ann.id}`} class="timeline-item">
                        <div class="timeline-date-col">
                            <span class="date-badge">
                                <span class="date-day">{new Date(ann.published_date).getDate()}</span>
                                <span class="date-month">{new Date(ann.published_date).toLocaleDateString('en-US', {month:'short'})}</span>
                            </span>
                        </div>
                        <div class="timeline-content glass-card">
                            <h2 class="ann-title">{ann.title}</h2>
                            <div class="meta-inline">
                                <Clock class="icon icon-xs" /> {formatDate(ann.published_date)}
                            </div>
                            <div class="prose" set:html={ann.content} />
                        </div>
                    </article>
                ))}
            </div>
        ) : (
            <div class="glass-card empty-state">
                <p>No announcements yet.</p>
            </div>
        )}
    </div>
</Layout>

<style>
    .page-header {
      text-align: center;
      padding: 4rem 0;
      background: linear-gradient(to bottom, rgba(255,255,255,0.5), transparent);
    }
    
    .page-title {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      color: var(--text-main);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
    }
    
    .page-desc {
        color: var(--text-muted);
        max-width: 600px;
        margin: 0 auto;
        font-size: 1.1rem;
    }
    
    .icon-lg { width: 2.5rem; height: 2.5rem; color: var(--accent-primary); }
    .icon-xs { width: 0.8em; height: 0.8em; vertical-align: middle; margin-right: 0.25rem; }

    .container-narrow {
        max-width: 800px;
    }

    .timeline-container {
        display: flex;
        flex-direction: column;
        gap: 2rem;
        padding-bottom: 5rem;
        position: relative;
    }
    
    /* Center line */
    .timeline-container::before {
        content: '';
        position: absolute;
        top: 0;
        bottom: 0;
        left: 2rem; /* Align with date badges */
        width: 2px;
        background: linear-gradient(to bottom, var(--accent-soft), transparent);
        z-index: 0;
    }
    
    .timeline-item {
        display: flex;
        gap: 2rem;
        position: relative;
        z-index: 1;
    }
    
    .timeline-date-col {
        flex-shrink: 0;
        width: 4rem;
        padding-top: 0.5rem;
        background: var(--bg-main); /* Mask line behind */
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    .date-badge {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 3.5rem;
        height: 3.5rem;
        background: var(--bg-surface-solid);
        border: 2px solid var(--accent-soft);
        border-radius: 12px;
        box-shadow: var(--shadow-sm);
        color: var(--accent-primary);
        font-weight: 700;
        z-index: 2;
    }
    
    .date-day { font-size: 1.25rem; line-height: 1; }
    .date-month { font-size: 0.75rem; text-transform: uppercase; }
    
    .timeline-content {
        flex: 1;
        /* Glass card extended */
        padding: 2rem;
        position: relative;
    }
    
    .timeline-content::before {
        /* Arrow pointing to date */
        content: '';
        position: absolute;
        top: 1.5rem;
        left: -8px;
        width: 16px;
        height: 16px;
        background: var(--bg-surface); /* Match glass bg */
        border-left: 1px solid var(--border-subtle); /* Match border */
        border-bottom: 1px solid var(--border-subtle);
        transform: rotate(45deg);
        z-index: 2;
    }
    
    .ann-title {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        line-height: 1.3;
        color: var(--text-main);
    }
    
    .meta-inline {
        font-size: 0.85rem;
        color: var(--text-muted);
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px dashed var(--border-subtle);
        display: flex;
        align-items: center;
    }
    
    .empty-state {
        text-align: center;
        padding: 4rem;
        color: var(--text-muted);
    }
    
    @media (max-width: 600px) {
        .timeline-container {
            gap: 3rem;
        }
        .timeline-container::before {
            display: none;
        }
        .timeline-item {
            flex-direction: column;
            gap: 1rem;
        }
        .timeline-date-col {
            width: 100%;
            flex-direction: row;
            justify-content: flex-start;
            background: transparent;
        }
        .date-badge {
             flex-direction: row;
             width: auto;
             height: auto;
             padding: 0.5rem 1rem;
             gap: 0.5rem;
        }
        .date-day { font-size: 1rem; }
        .timeline-content::before {
            display: none;
        }
    }
</style>
