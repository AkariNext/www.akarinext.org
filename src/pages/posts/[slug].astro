---
import Layout from "../../layouts/Layout.astro";
import { directus, readItems, skipDirectusFetch } from "../../lib/directus";
import { Calendar, User, ArrowLeft, Image as ImageIcon, Gamepad2, Code2, MessageCircle, Zap, Tag as TagIcon } from "lucide-astro";

export async function getStaticPaths() {
	if (skipDirectusFetch) return [];
	try {
		const posts =
			(await directus.request(
				readItems("posts", {
					fields: ["slug"],
					filter: { status: { _eq: "published" } },
				}),
			)) ?? [];
		return posts.map((post: { slug: string }) => ({
			params: { slug: post.slug },
		}));
	} catch {
		return [];
	}
}

const { slug } = Astro.params;
let post = null;

if (!skipDirectusFetch) {
	try {
        const result = await directus.request(
            readItems("posts", {
                fields: [
                    "title",
                    "content",
                    "published_date",
                    "category",
                    "tags",
                    { author: ["id", "name", "avatar", "bio"] },
                    "image",
                ],
                filter: { slug: { _eq: slug } },
                limit: 1,
            })
        );
        post = result?.[0] || null;
	} catch (e) {
		// Silent error
	}
}

if (!post) {
	return Astro.redirect("/posts");
}

const directusUrl =
	import.meta.env.PUBLIC_DIRECTUS_URL || "http://localhost:8055";

const getImageUrl = (imageVal: string | { id: string } | null | undefined) => {
    if (!imageVal) return null;
    const id = typeof imageVal === 'string' ? imageVal : imageVal.id;
    return `${directusUrl}/assets/${id}`;
}

const imageUrl = getImageUrl(post.image);
const avatarUrl = getImageUrl(post.author?.avatar);

const displayDate = post.published_date || new Date().toISOString();

const formatDate = (date: string) => {
    return new Date(date).toLocaleDateString('ja-JP', {
       year: 'numeric',
       month: 'long',
       day: 'numeric' 
    });
};

const getCategoryIcon = (cat: string) => {
    switch(cat) {
        case 'tech': return Code2;
        case 'game': return Gamepad2;
        case 'misc': return MessageCircle;
        default: return MessageCircle;
    }
}
const CategoryIcon = getCategoryIcon(post.category);
---

<Layout title={post.title} description={post.content?.replace(/<[^>]*>/g, '').substring(0, 160) || ''} image={imageUrl || undefined}>
    <!-- Reading Progress Bar -->
    <div id="progress-bar" class="progress-bar-container">
        <div class="progress-bar-fill"></div>
    </div>

    <article class="post-detail-premium">
        <header class="post-header-block">
            <div class="container container-medium reveal-fade">
                <div class="header-meta-group">
                    <div class="meta-left">
                        <div class="category-indicator">
                            <CategoryIcon class="icon icon-xs" />
                            <span>{post.category.toUpperCase()}</span>
                        </div>
                        <div class="date-indicator">
                            <Calendar class="icon icon-xs" />
                            <span>{formatDate(displayDate)}</span>
                        </div>
                    </div>
                    <div class="meta-right">
                        <span class="read-time"><Zap class="icon icon-xs text-yellow" /> 読了目安: {Math.max(1, Math.ceil(post.content?.length / 500))}分</span>
                    </div>
                </div>
                
                <h1 class="post-title-giant">{post.title}</h1>
                
                {post.author && (
                    <div class="header-author-row">
                        <a href={`/users/${post.author.id}`} class="author-pill">
                            {avatarUrl ? (
                                <img src={`${avatarUrl}?width=64&height=64&fit=cover`} alt={post.author.name} class="author-pill-img" />
                            ) : (
                                <div class="author-pill-placeholder"><User class="icon" /></div>
                            )}
                            <div class="author-pill-text">
                                <span class="pill-label">著者</span>
                                <span class="pill-name">{post.author.name}</span>
                            </div>
                        </a>
                    </div>
                )}
            </div>
            
            {imageUrl ? (
                <div class="hero-image-wrapper container">
                    <img src={imageUrl} alt={post.title} class="hero-image" />
                </div>
            ) : (
                <div class="hero-image-placeholder container">
                </div>
            )}
        </header>

        <div class="container container-medium content-container">
            <div class="glass-card content-card">
                <div class="prose" set:html={post.content} />
                
                {post.tags && post.tags.length > 0 && (
                    <div class="tags-section reveal-fade">
                        <h4 class="tags-title">関連タグ</h4>
                        <div class="tags-list">
                            {post.tags.map((tag: string) => (
                                <a href={`/posts?tag=${tag}`} class="tag-premium">
                                    <TagIcon class="icon-tag" />
                                    <span>{tag}</span>
                                </a>
                            ))}
                        </div>
                    </div>
                )}
            </div>

            {post.author && (
                <div class="author-bio-section glass-card">
                    <div class="bio-avatar-box">
                        {avatarUrl ? (
                            <img src={`${avatarUrl}?width=120&height=120&fit=cover`} alt={post.author.name} class="bio-img" />
                        ) : (
                            <div class="bio-img-placeholder"><User class="icon icon-lg" /></div>
                        )}
                    </div>
                    <div class="bio-info-box">
                        <div class="bio-top">
                            <h3 class="bio-author-name">{post.author.name}</h3>
                            <a href={`/users/${post.author.id}`} class="bio-profile-link">プロフィールを見る <ArrowLeft class="icon icon-xs rotate-180" /></a>
                        </div>
                        {post.author.bio && <p class="bio-description">{post.author.bio}</p>}
                    </div>
                </div>
            )}
            
            <div class="post-navigation reveal-fade">
                <a href="/posts" class="back-link-premium">
                    <div class="back-icon-circle">
                        <ArrowLeft class="icon" />
                    </div>
                    <span>記事一覧に戻る</span>
                </a>
            </div>
        </div>
    </article>

    <script>
        // Progress Bar logic
        window.addEventListener('scroll', () => {
            const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
            const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
            const scrolled = (winScroll / height) * 100;
            const barFill = document.querySelector('.progress-bar-fill') as HTMLElement;
            if (barFill) barFill.style.width = scrolled + "%";
        });

        // Simple Reveal Animation
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('is-visible');
                }
            });
        }, { threshold: 0.1 });

        document.querySelectorAll('.reveal-fade').forEach(el => observer.observe(el));
    </script>
</Layout>

<style>
    .progress-bar-container {
        position: fixed;
        top: 60px; /* Adjust based on your header height */
        left: 0;
        width: 100%;
        height: 4px;
        background: transparent;
        z-index: 1000;
    }

    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
        width: 0%;
        transition: width 0.1s ease-out;
    }

    .reveal-fade {
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.8s cubic-bezier(0.2, 1, 0.2, 1);
    }

    .reveal-fade.is-visible {
        opacity: 1;
        transform: translateY(0);
    }
    
    .post-detail-premium {
        padding-bottom: 8rem;
    }

    .post-navigation {
        margin-top: 8rem;
        display: flex;
        justify-content: center;
    }
    
    .post-header-block {
        padding-top: 6rem;
        background: 
            radial-gradient(circle at 10% 0%, var(--accent-soft), transparent 40%),
            radial-gradient(circle at 90% 10%, rgba(14, 165, 233, 0.08), transparent 40%);
        padding-bottom: 8rem;
    }
    
    .header-meta-group {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2.5rem;
        gap: 1.5rem;
        flex-wrap: wrap;
    }

    .meta-left {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .category-indicator {
        color: var(--accent-primary);
        background: var(--accent-soft);
        padding: 0.4rem 1rem;
        border-radius: 8px;
        font-size: 0.8rem;
        font-weight: 800;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .date-indicator {
        color: var(--text-muted);
        font-size: 0.85rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .read-time {
        font-size: 0.85rem;
        color: var(--text-muted);
        background: var(--bg-surface);
        padding: 0.4rem 1rem;
        border-radius: 100px;
        border: 1px solid var(--border-subtle);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .post-title-giant {
        font-size: 3.75rem;
        line-height: 1.1;
        font-weight: 900;
        color: var(--text-main);
        letter-spacing: -0.04em;
        margin-bottom: 2.5rem;
        filter: drop-shadow(0 10px 20px rgba(0,0,0,0.05));
    }

    .header-author-row {
        display: flex;
        align-items: center;
    }

    .author-pill {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.65rem 1.75rem 0.65rem 0.65rem;
        background: var(--bg-surface);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid var(--border-glass);
        border-radius: 100px;
        transition: all 0.4s cubic-bezier(0.2, 1, 0.2, 1);
        box-shadow: var(--shadow-glass);
    }

    .author-pill:hover {
        transform: translateY(-5px) scale(1.02);
        background: var(--bg-surface-hover);
        border-color: var(--accent-primary);
        box-shadow: var(--shadow-hover);
    }

    .author-pill-img {
        width: 52px;
        height: 52px;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .author-pill-placeholder {
        width: 52px;
        height: 52px;
        background: var(--accent-soft);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--accent-primary);
    }

    .author-pill-text {
        display: flex;
        flex-direction: column;
    }

    .pill-label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; font-weight: 700; }
    .pill-name { font-size: 1.05rem; font-weight: 800; }
    
    .hero-image-wrapper {
        margin-top: 5rem;
        margin-bottom: -6rem;
        position: relative;
        z-index: 10;
        padding: 0 1rem;
    }
    
    .hero-image {
        width: 100%;
        max-width: 1100px;
        margin: 0 auto;
        display: block;
        height: 60vh;
        object-fit: cover;
        border-radius: 32px;
        box-shadow: 0 10px 30px -10px rgba(0,0,0,0.1);
        border: 1px solid var(--border-glass);
    }
    
    .content-card {
        padding: 4rem 3.5rem;
        background: var(--bg-surface-solid);
        border-radius: 24px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.05);
    }

    :global([data-theme="dark"]) .content-card {
        background: rgba(30, 41, 59, 0.8);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
    }

    .tags-section {
        margin-top: 5rem;
        padding-top: 3rem;
        border-top: 1px dashed var(--border-subtle);
    }

    .tags-title {
        font-size: 0.9rem;
        font-weight: 800;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin-bottom: 1.5rem;
        display: block;
    }
    
    .tags-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.85rem;
    }
    
    .tag-premium {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.85rem;
        font-weight: 700;
        color: var(--text-main);
        background: var(--bg-surface);
        padding: 0.5rem 1.25rem;
        border-radius: 12px;
        border: 1px solid var(--border-subtle);
        transition: all 0.3s cubic-bezier(0.2, 1, 0.2, 1);
        text-decoration: none;
        box-shadow: var(--shadow-sm);
    }

    .icon-tag {
        width: 0.9rem;
        height: 0.9rem;
        color: var(--accent-primary);
        opacity: 0.7;
    }
    
    .tag-premium:hover {
        background: var(--accent-primary);
        color: white;
        border-color: var(--accent-primary);
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 10px 20px -5px rgba(14, 165, 233, 0.4);
    }

    .tag-premium:hover .icon-tag {
        color: white;
        opacity: 1;
    }
    
    .author-bio-section {
        margin-top: 6rem;
        padding: 4rem;
        background: linear-gradient(135deg, var(--bg-surface), var(--bg-surface-hover));
        border-radius: 32px;
        border: 1px solid var(--border-glass);
    }

    .bio-img {
        width: 120px;
        height: 120px;
        border-radius: 40px;
        rotate: -3deg;
        transition: transform 0.3s ease;
    }

    .author-bio-section:hover .bio-img {
        transform: rotate(3deg) scale(1.05);
    }

    .bio-author-name { font-size: 1.75rem; font-weight: 900; }
    
    .back-link-premium {
        display: inline-flex;
        align-items: center;
        gap: 1.25rem;
        text-decoration: none;
        color: var(--text-muted);
        font-weight: 700;
        transition: all 0.3s ease;
    }

    .back-icon-circle {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: var(--bg-surface);
        border: 1px solid var(--border-subtle);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s cubic-bezier(0.2, 1, 0.2, 1);
    }

    .back-link-premium:hover {
        color: var(--accent-primary);
    }

    .back-link-premium:hover .back-icon-circle {
        background: var(--accent-primary);
        color: white;
        transform: translateX(-5px);
        border-color: var(--accent-primary);
    }
    
    @media (max-width: 1024px) {
        .post-title-giant { font-size: 3.5rem; }
        .hero-image { height: 40vh; }
    }

    @media (max-width: 768px) {
        .post-header-block { padding-top: 4rem; padding-bottom: 6rem; }
        .post-title-giant { font-size: 2.5rem; letter-spacing: -0.03em; margin-bottom: 2rem; }
        .content-card { padding: 2.5rem 1.5rem; border-radius: 20px; }
        .hero-image-wrapper { margin-top: 3rem; margin-bottom: -4rem; }
        .hero-image { border-radius: 16px; height: 35vh; }
        .author-bio-section { padding: 2rem 1.5rem; margin-top: 4rem; }
    }
</style>

