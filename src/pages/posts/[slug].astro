---
import Layout from "../../layouts/Layout.astro";
import { directus, readItems, skipDirectusFetch } from "../../lib/directus";
import { processContentHtml } from "../../lib/content";
import { Calendar, User, ArrowLeft, Image as ImageIcon, Gamepad2, Code2, MessageCircle, MessageSquare, Zap, Tag as TagIcon, Twitter, Github, Globe, Twitch, Youtube, Shield } from "lucide-astro";



const { slug } = Astro.params;
let post = null;

if (!skipDirectusFetch) {
	try {
        // slug が数値なら id で検索、そうでなければ slug で検索
        const isNumeric = /^\d+$/.test(slug || "");
        const filter = isNumeric
            ? { id: { _eq: parseInt(slug!, 10) } }
            : { slug: { _eq: slug } };
        const result = await directus.request(
            readItems("posts", {
                fields: [
                    "title",
                    "content",
                    "published_date",
                    "category",
                    "tags",
                    { author: ["id", "name", "avatar", "bio", "social_links", "is_staff", "staff_title"] },
                    "image",
                ],
                filter: { ...filter, status: { _eq: "published" } },
                limit: 1,
            })
        );
        post = result?.[0] || null;
	} catch (e) {
		// Silent error
	}
}

if (!post) {
	return Astro.redirect("/posts");
}

const directusUrl =
	import.meta.env.PUBLIC_DIRECTUS_URL || "http://localhost:8055";

const getImageUrl = (imageVal: string | { id: string } | null | undefined) => {
    if (!imageVal) return null;
    const id = typeof imageVal === 'string' ? imageVal : imageVal.id;
    return `${directusUrl}/assets/${id}`;
}

const imageUrl = getImageUrl(post.image);
const avatarUrl = getImageUrl(post.author?.avatar);

const displayDate = post.published_date || new Date().toISOString();

const formatDate = (date: string) => {
    return new Date(date).toLocaleDateString('ja-JP', {
       year: 'numeric',
       month: 'long',
       day: 'numeric' 
    });
};

const getCategoryIcon = (cat: string) => {
    switch(cat) {
        case 'tech': return Code2;
        case 'game': return Gamepad2;
        case 'misc': return MessageCircle;
        default: return MessageCircle;
    }
}
const CategoryIcon = getCategoryIcon(post.category);

const getSocialIcon = (platform: string) => {
    switch (platform?.toLowerCase()) {
        case 'twitter': return Twitter;
        case 'x': return Twitter;
        case 'github': return Github;
        case 'twitch': return Twitch;
        case 'youtube': return Youtube;
        case 'discord': return MessageSquare;
        default: return Globe;
    }
};

let processedContent = '';
if (post.content) {
    const contentWithCode = post.content.replace(/`([^`]+)`/g, '<code>$1</code>');
    processedContent = await processContentHtml(contentWithCode);
}
---

<Layout title={post.title} description={post.content?.replace(/<[^>]*>/g, '').substring(0, 160) || ''} image={imageUrl || undefined}>
    <!-- Reading Progress Bar -->
    <div id="progress-bar" class="progress-bar-container">
        <div class="progress-bar-fill"></div>
    </div>

    <article class="post-detail-premium">
        <header class="post-header-block">
            <div class="container container-medium reveal-fade">
                <div class="header-meta-group">
                    <div class="meta-left">
                        <div class="category-indicator">
                            <CategoryIcon class="icon icon-xs" />
                            <span>{post.category.toUpperCase()}</span>
                        </div>
                        <div class="date-indicator">
                            <Calendar class="icon icon-xs" />
                            <span>{formatDate(displayDate)}</span>
                        </div>
                    </div>
                    <div class="meta-right">
                        <span class="read-time"><Zap class="icon icon-xs text-yellow" /> 読了目安: {Math.max(1, Math.ceil(post.content?.length / 500))}分</span>
                    </div>
                </div>
                
                <h1 class="post-title-giant">{post.title}</h1>
                
                {post.author && (
                    <div class="header-author-row">
                        <a href={`/users/${post.author.id}`} class="author-pill">
                            {avatarUrl ? (
                                <img src={`${avatarUrl}?width=64&height=64&fit=cover`} alt={post.author.name} class="author-pill-img" />
                            ) : (
                                <div class="author-pill-placeholder"><User class="icon" /></div>
                            )}
                            <div class="author-pill-text">
                                <span class="pill-label">著者</span>
                                <span class="pill-name">{post.author.name}</span>
                            </div>
                        </a>
                    </div>
                )}
            </div>
            
            {imageUrl ? (
                <div class="hero-image-wrapper container">
                    <img 
                        src={`${imageUrl}?width=1280&format=webp&quality=80`} 
                        srcset={`
                            ${imageUrl}?width=640&format=webp&quality=80 640w,
                            ${imageUrl}?width=1280&format=webp&quality=80 1280w,
                            ${imageUrl}?width=1920&format=webp&quality=80 1920w
                        `}
                        sizes="(max-width: 768px) 100vw, 1100px"
                        alt={post.title} 
                        class="hero-image" 
                        loading="eager"
                        decoding="async"
                    />
                </div>
            ) : (
                <div class="hero-image-placeholder container">
                </div>
            )}
        </header>

        <div class="container container-medium content-container">
            <div class="glass-card content-card">
                <div class="prose" set:html={processedContent} />
                
                {post.tags && post.tags.length > 0 && (
                    <div class="tags-section reveal-fade">
                        <h4 class="tags-title">関連タグ</h4>
                        <div class="tags-list">
                            {post.tags.map((tag: string) => (
                                <a href={`/posts?tag=${tag}`} class="tag-premium">
                                    <TagIcon class="icon-tag" />
                                    <span>{tag}</span>
                                </a>
                            ))}
                        </div>
                    </div>
                )}
            </div>

            {post.author && (
                <div class="author-bio-card reveal-fade">
                    <div class="card-glow"></div>
                    <div class="bio-content-horizontal">
                        <div class="bio-visual">
                            <div class="author-avatar-group">
                                {avatarUrl ? (
                                    <img src={`${avatarUrl}?width=160&height=160&fit=cover`} alt={post.author.name} class="bio-img-premium" />
                                ) : (
                                    <div class="bio-img-placeholder-premium"><User class="icon icon-lg" /></div>
                                )}
                                {post.author.is_staff && (
                                    <div class="staff-avatar-badge" title="Official Staff">
                                        <Shield class="icon-tiny" />
                                    </div>
                                )}
                            </div>
                        </div>
                        <div class="bio-details">
                            <header class="bio-header">
                                <div class="name-box">
                                    <div class="name-badge-row">
                                        <h3 class="bio-name-clean">{post.author.name}</h3>
                                        {post.author.is_staff && (
                                            <span class="staff-chip">
                                                STAFF
                                            </span>
                                        )}
                                    </div>
                                    {post.author.staff_title && <span class="author-role-text">{post.author.staff_title}</span>}
                                </div>
                                {post.author.social_links && post.author.social_links.length > 0 && (
                                    <div class="author-socials">
                                        {post.author.social_links.map((link: any) => {
                                            const SocialIcon = getSocialIcon(link.platform);
                                            return (
                                                <a href={link.url} target="_blank" rel="noopener noreferrer" class="social-icon-btn" title={link.platform}>
                                                    <SocialIcon class="icon-xs" />
                                                </a>
                                            );
                                        })}
                                    </div>
                                )}
                            </header>
                            <p class="bio-text-modern">{post.author.bio || "この著者のプロフィールはまだ登録されていません。"}</p>
                            <div class="bio-footer">
                                <a href={`/users/${post.author.id}`} class="btn-profile-premium">
                                    <span>すべての記事を見る</span>
                                    <ArrowLeft class="icon icon-xs rotate-180" />
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            )}
            
            <div class="post-navigation reveal-fade">
                <a href="/posts" class="back-link-premium">
                    <div class="back-icon-circle">
                        <ArrowLeft class="icon" />
                    </div>
                    <span>記事一覧に戻る</span>
                </a>
            </div>
        </div>
    </article>

    <script>
        // Progress Bar logic
        window.addEventListener('scroll', () => {
            const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
            const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
            const scrolled = (winScroll / height) * 100;
            const barFill = document.querySelector('.progress-bar-fill') as HTMLElement;
            if (barFill) barFill.style.width = scrolled + "%";
        });

        // Simple Reveal Animation
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('is-visible');
                }
            });
        }, { threshold: 0.1 });

        document.querySelectorAll('.reveal-fade').forEach(el => observer.observe(el));
    </script>
</Layout>

<style>
    .progress-bar-container {
        position: fixed;
        top: 60px; /* Adjust based on your header height */
        left: 0;
        width: 100%;
        height: 4px;
        background: transparent;
        z-index: 1000;
    }

    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
        width: 0%;
        transition: width 0.1s ease-out;
    }

    .reveal-fade {
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.8s cubic-bezier(0.2, 1, 0.2, 1);
    }

    .reveal-fade.is-visible {
        opacity: 1;
        transform: translateY(0);
    }
    
    .post-detail-premium {
        padding-bottom: 8rem;
    }

    .post-navigation {
        margin-top: 8rem;
        display: flex;
        justify-content: center;
    }
    
    .post-header-block {
        padding-top: 6rem;
        background: 
            radial-gradient(circle at 10% 0%, var(--accent-soft), transparent 40%),
            radial-gradient(circle at 90% 10%, rgba(14, 165, 233, 0.08), transparent 40%);
        padding-bottom: 8rem;
    }
    
    .header-meta-group {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2.5rem;
        gap: 1.5rem;
        flex-wrap: wrap;
    }

    .meta-left {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .category-indicator {
        color: var(--accent-primary);
        background: var(--accent-soft);
        padding: 0.4rem 1rem;
        border-radius: 8px;
        font-size: 0.8rem;
        font-weight: 800;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .date-indicator {
        color: var(--text-muted);
        font-size: 0.85rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .read-time {
        font-size: 0.85rem;
        color: var(--text-muted);
        background: var(--bg-surface);
        padding: 0.4rem 1rem;
        border-radius: 100px;
        border: 1px solid var(--border-subtle);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .post-title-giant {
        font-size: 3.75rem;
        line-height: 1.1;
        font-weight: 900;
        color: var(--text-main);
        letter-spacing: -0.04em;
        margin-bottom: 2.5rem;
        filter: drop-shadow(0 10px 20px rgba(0,0,0,0.05));
    }

    .header-author-row {
        display: flex;
        align-items: center;
    }

    .author-pill {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.65rem 1.75rem 0.65rem 0.65rem;
        background: var(--bg-surface);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid var(--border-glass);
        border-radius: 100px;
        transition: all 0.4s cubic-bezier(0.2, 1, 0.2, 1);
        box-shadow: var(--shadow-glass);
    }

    .author-pill:hover {
        transform: translateY(-5px) scale(1.02);
        background: var(--bg-surface-hover);
        border-color: var(--accent-primary);
        box-shadow: var(--shadow-hover);
    }

    .author-pill-img {
        width: 52px;
        height: 52px;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .author-pill-placeholder {
        width: 52px;
        height: 52px;
        background: var(--accent-soft);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--accent-primary);
    }

    .author-pill-text {
        display: flex;
        flex-direction: column;
    }

    .pill-label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; font-weight: 700; }
    .pill-name { font-size: 1.05rem; font-weight: 800; }
    
    .hero-image-wrapper {
        margin-top: 5rem;
        margin-bottom: -6rem;
        position: relative;
        z-index: 10;
        padding: 0 1rem;
    }
    
    .hero-image {
        width: 100%;
        max-width: 1100px;
        margin: 0 auto;
        display: block;
        height: 60vh;
        object-fit: cover;
        border-radius: 32px;
        box-shadow: 0 10px 30px -10px rgba(0,0,0,0.1);
        border: 1px solid var(--border-glass);
    }
    
    .content-card {
        padding: 4rem 3.5rem;
        background: var(--bg-surface-solid);
        border-radius: 24px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.05);
    }

    :global([data-theme="dark"]) .content-card {
        background: rgba(30, 41, 59, 0.8);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
    }

    .tags-section {
        margin-top: 5rem;
        padding-top: 3rem;
        border-top: 1px dashed var(--border-subtle);
    }

    .tags-title {
        font-size: 0.9rem;
        font-weight: 800;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin-bottom: 1.5rem;
        display: block;
    }
    
    .tags-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.85rem;
    }
    
    .tag-premium {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.85rem;
        font-weight: 700;
        color: var(--text-main);
        background: var(--bg-surface);
        padding: 0.5rem 1.25rem;
        border-radius: 12px;
        border: 1px solid var(--border-subtle);
        transition: all 0.3s cubic-bezier(0.2, 1, 0.2, 1);
        text-decoration: none;
        box-shadow: var(--shadow-sm);
    }

    .icon-tag {
        width: 0.9rem;
        height: 0.9rem;
        color: var(--accent-primary);
        opacity: 0.7;
    }
    
    .tag-premium:hover {
        background: var(--accent-primary);
        color: white;
        border-color: var(--accent-primary);
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 10px 20px -5px rgba(14, 165, 233, 0.4);
    }

    .tag-premium:hover .icon-tag {
        color: white;
        opacity: 1;
    }
    
    /* Author Bio Card - Premium */
    .author-bio-card {
        margin-top: 6rem;
        position: relative;
        padding: 3.5rem;
        background: var(--bg-surface);
        backdrop-filter: blur(24px);
        -webkit-backdrop-filter: blur(24px);
        border: 1px solid var(--border-glass);
        border-radius: 40px;
        overflow: hidden;
        box-shadow: var(--shadow-glass);
        transition: all 0.5s cubic-bezier(0.2, 1, 0.2, 1);
    }

    .author-bio-card:hover {
        transform: translateY(-8px);
        box-shadow: var(--shadow-hover), 0 20px 40px rgba(0,0,0,0.1);
        border-color: var(--accent-primary);
    }

    .card-glow {
        position: absolute;
        width: 300px;
        height: 300px;
        background: radial-gradient(circle, var(--accent-primary) 0%, transparent 70%);
        top: -150px;
        right: -150px;
        opacity: 0.05;
        pointer-events: none;
        transition: opacity 0.5s ease;
    }

    .author-bio-card:hover .card-glow {
        opacity: 0.1;
    }

    /* Author Bio Card - Refined Modern */
    .author-bio-card {
        margin-top: 6rem;
        position: relative;
        padding: 3rem;
        background: var(--bg-surface);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid var(--border-subtle);
        border-radius: 32px;
        box-shadow: var(--shadow-sm);
        transition: all 0.4s ease;
    }

    .author-bio-card:hover {
        border-color: var(--accent-primary);
        box-shadow: var(--shadow-glass);
    }

    .bio-content-horizontal {
        display: flex;
        gap: 3rem;
        align-items: flex-start;
    }

    .author-avatar-group {
        position: relative;
        flex-shrink: 0;
    }

    .bio-img-premium, .bio-img-placeholder-premium {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        object-fit: cover;
        border: 1px solid var(--border-subtle);
        background: var(--bg-surface-solid);
        padding: 4px;
    }

    .staff-avatar-badge {
        position: absolute;
        bottom: 5px;
        right: 5px;
        width: 28px;
        height: 28px;
        background: var(--accent-primary);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid var(--bg-surface-solid);
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    .bio-details {
        flex: 1;
    }

    .bio-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
        gap: 2rem;
    }

    .name-badge-row {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 0.25rem;
    }

    .bio-name-clean {
        font-size: 1.85rem;
        font-weight: 800;
        color: var(--text-main);
        letter-spacing: -0.03em;
        line-height: 1.2;
    }

    .staff-chip {
        font-size: 0.65rem;
        font-weight: 800;
        padding: 0.2rem 0.6rem;
        background: var(--accent-soft);
        color: var(--accent-primary);
        border-radius: 6px;
        letter-spacing: 0.05em;
        border: 1px solid rgba(14, 165, 233, 0.2);
    }

    .author-role-text {
        font-size: 0.95rem;
        color: var(--text-muted);
        font-weight: 600;
        display: block;
    }

    .author-socials {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .social-icon-btn {
        width: 38px;
        height: 38px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--bg-surface-hover);
        border: 1px solid var(--border-light);
        border-radius: 12px;
        color: var(--text-muted);
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .social-icon-btn:hover {
        background: var(--accent-primary);
        color: white;
        border-color: var(--accent-primary);
        transform: translateY(-3px);
        box-shadow: 0 5px 15px var(--accent-soft);
    }

    .bio-text-modern {
        font-size: 1rem;
        line-height: 1.6;
        color: var(--text-muted);
        margin-bottom: 1.5rem;
        max-width: 580px;
    }

    .bio-footer {
        display: flex;
        justify-content: flex-start;
    }

    .btn-profile-premium {
        display: inline-flex;
        align-items: center;
        gap: 0.6rem;
        font-size: 0.95rem;
        font-weight: 700;
        color: var(--accent-primary);
        transition: all 0.2s;
    }

    .btn-profile-premium:hover {
        color: var(--accent-secondary);
        transform: translateX(5px);
    }

    .icon-tiny {
        width: 0.8rem;
        height: 0.8rem;
    }

    @media (max-width: 768px) {
        .author-bio-card { padding: 2.5rem 1.5rem; }
        .bio-content-horizontal { flex-direction: column; gap: 2rem; text-align: center; }
        .bio-header { flex-direction: column; align-items: center; gap: 1.5rem; }
        .name-badge-row { justify-content: center; }
        .bio-footer { justify-content: center; }
        .author-socials { justify-content: center; }
    }
    
    .back-link-premium {
        display: inline-flex;
        align-items: center;
        gap: 1.25rem;
        text-decoration: none;
        color: var(--text-muted);
        font-weight: 700;
        transition: all 0.3s ease;
    }

    .back-icon-circle {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: var(--bg-surface);
        border: 1px solid var(--border-subtle);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s cubic-bezier(0.2, 1, 0.2, 1);
    }

    .back-link-premium:hover {
        color: var(--accent-primary);
    }

    .back-link-premium:hover .back-icon-circle {
        background: var(--accent-primary);
        color: white;
        transform: translateX(-5px);
        border-color: var(--accent-primary);
    }
    
    @media (max-width: 1024px) {
        .post-title-giant { font-size: 3.5rem; }
        .hero-image { height: 40vh; }
    }

    @media (max-width: 768px) {
        .post-header-block { padding-top: 4rem; padding-bottom: 6rem; }
        .post-title-giant { font-size: 2.5rem; letter-spacing: -0.03em; margin-bottom: 2rem; }
        .content-card { padding: 2.5rem 1.5rem; border-radius: 20px; }
        .hero-image-wrapper { margin-top: 3rem; margin-bottom: -4rem; }
        .hero-image { border-radius: 16px; height: 35vh; }
        .author-bio-section { padding: 2rem 1.5rem; margin-top: 4rem; }
    }
</style>

